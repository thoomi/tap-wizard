"use strict";angular.module("clientApp",["ngRoute","hmTouchEvents"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/joingame",{templateUrl:"views/joingame.html",controller:"JoingameCtrl"}).when("/creategame",{templateUrl:"views/creategame.html",controller:"CreategameCtrl"}).when("/playergame",{templateUrl:"views/playergame.html",controller:"PlayergameCtrl"}).when("/hostgame",{templateUrl:"views/hostgame.html",controller:"HostgameCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("clientApp").controller("MainCtrl",["$scope",function(a){a.game={start:"new game",join:"join game"}}]),angular.module("clientApp").factory("socket",["$rootScope",function(a){var b=io.connect("http://wiz.herokuapp.com");return{on:function(c,d){b.on(c,function(){var c=arguments;a.$apply(function(){d.apply(b,c)})})},emit:function(c,d,e){b.emit(c,d,function(){var c=arguments;a.$apply(function(){e&&e.apply(b,c)})})},removeAllListeners:function(){b.removeAllListeners()}}}]),angular.module("clientApp").controller("JoingameCtrl",["$scope","$location","socket","gameData",function(a,b,c,d){a.joinGameText="Join",a.isConnectDisabled=!1,d.playerName="Player",d.gameId=0,a.connectToGame=function(){a.isConnectDisabled=!0,a.joinGameText="Joining..",d.playerName=a.playerName,d.gameId=a.gameId,c.emit("playerJoinGame",d)},c.on("playerJoinSuccess",function(){b.path("playergame")}),c.on("error",function(b){console.log("Error: "+b),a.isConnectDisabled=!1,a.joinGameText="Join"}),a.$on("$destroy",function(){c.removeAllListeners()})}]),angular.module("clientApp").controller("CreategameCtrl",["$scope","$location","socket","hostGameData",function(a,b,c,d){a.game={wait:"Waiting for other players to join:",play:"Start",players:[]},a.isStartDisabled=!0,d.gameId=0,d.currentRound=1,d.maxRounds=20,d.players=[],c.on("connected",function(){console.log("Websocket connected")}),c.on("newGameCreated",function(b){a.game.id=b.gameId,d.gameId=b.gameId}),c.on("playerJoinedGame",function(b){a.game.players.push(b),d.players.push(b),a.game.players.length>=3&&(a.isStartDisabled=!1)}),c.on("playerLeftGame",function(b){for(var c=0;c<a.game.players.length;c++)a.game.players[c].playerId===b&&(a.game.players.splice(c,1),d.players.splice(c,1));a.game.players.length<3&&(a.isStartDisabled=!0)}),c.on("beginNewGame",function(a){d.maxRounds=a.maxRounds,b.path("hostgame")}),a.prepareGameForPlay=function(){a.isStartDisabled=!0,c.emit("hostPrepareGame",d.gameId)},c.emit("hostCreateNewGame"),a.$on("$destroy",function(){c.removeAllListeners()}),a.range=function(a){return new Array(a)}}]),angular.module("clientApp").controller("PlayergameCtrl",["$scope","socket","gameData",function(a,b,c){a.cards=[],a.currentRound=0,a.notification="Waiting for the host to start the game!",a.isGuessTricksDisabled=!0,a.gameOver=!1,a.winnerName="",a.playedCardThisTrick=!1,a.isThrowCardsDisabled=!0,b.on("newHandCard",function(b){a.cards.push(b)}),b.on("beginNewGame",function(){a.notification="Game is running!"}),b.on("cardNotAllowed",function(b){a.notification="Sorry, card is not allowed: "+b.suit+" "+b.value,a.cards.push(b),a.playedCardThisTrick=!1}),b.on("startNewRound",function(b){a.currentRound=b,a.isGuessTricksDisabled=!1,a.notification="Please guess your number of tricks.",a.isThrowCardsDisabled=!0}),b.on("playerHasWonTrick",function(){a.playedCardThisTrick=!1}),b.on("playerIsDealer",function(){a.notification='Hit "Start Round" on the gametable, please. You\'re the dealer!'}),b.on("playerBeginTrick",function(){a.notification="Your are the first player in this round."}),b.on("allTricksGuessed",function(){a.isThrowCardsDisabled=!1,a.notification="Game is running!"}),b.on("gameIsOver",function(b){a.notification="Game is over!",a.winnerName=b,a.gameOver=!0}),a.throwCard=function(d){if(a.playedCardThisTrick===!1&&a.isThrowCardsDisabled===!1){var e={gameId:c.gameId,card:d};b.emit("playerThrowCard",e);for(var f=0;f<a.cards.length;f++)a.cards[f].suit===d.suit&&a.cards[f].value===d.value&&a.cards.splice(f,1);return a.playedCardThisTrick=!0,!0}return!1},a.guessNumberOfTricks=function(d){var e={gameId:c.gameId,guessedTricks:d};b.emit("playerGuessTricks",e),a.isGuessTricksDisabled=!0,a.notification="Waiting for others to guess tricks."},a.$on("$destroy",function(){b.removeAllListeners()}),a.range=function(a){return new Array(a)}}]),angular.module("clientApp").factory("gameData",function(){var a="Player",b=0;return{playerName:a,gameId:b}}),angular.module("clientApp").controller("HostgameCtrl",["$scope","socket","hostGameData","$timeout",function(a,b,c,d){a.gameId=c.gameId,a.players=c.players,a.cards=[],a.round={current:c.currentRound,max:c.maxRounds},a.trickwinner="",a.trumpCard={},a.scores=[],a.gameOver=!1,a.winnerName="",a.isStartRoundDisabled=!1,b.on("playerHasThrownCard",function(b){a.cards.push(b)}),b.on("newTrumpCard",function(b){a.trumpCard=b}),b.on("playerGuessedTricks",function(b){a.scores[a.round.current][b.playerId]={},a.scores[a.round.current][b.playerId].guessedTricks=b.guessedTricks}),b.on("playerHasWonTrick",function(b){a.trickwinner=b,d(function(){a.cards=[],console.log("executed")},5e3)}),b.on("roundIsOver",function(b){a.trumpCard={};for(var c=0;c<a.players.length;c++){var d=a.players[c].playerId,e=a.players[c].points,f=b[d];a.scores[a.round.current][d].score=e+f,a.players[c].points=e+f}a.round.current++,a.isStartRoundDisabled=!1}),b.on("gameIsOver",function(b){a.winnerName=b,a.gameOver=!0}),a.startRound=function(){a.isStartRoundDisabled=!0,a.scores[a.round.current]={},a.trickwinner="",b.emit("hostStartRound",c.gameId)},a.range=function(a){return new Array(a)}}]),angular.module("clientApp").factory("hostGameData",function(){function a(a){for(var b=0;b<c.length;b++)if(c[b].playerId===a)return c[b]}var b=0,c=[],d=1,e=20;return{gameId:b,players:c,currentRound:d,maxRounds:e,numberOfPlayers:c.length,findPlayerById:a}}),angular.module("clientApp").directive("tbPlayingCard",["$document",function(a){function b(a){var b=a.changedTouches[0],c=document.createEvent("MouseEvent");c.initMouseEvent({touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup"}[a.type],!0,!0,window,1,b.screenX,b.screenY,b.clientX,b.clientY,!1,!1,!1,!1,0,null),b.target.dispatchEvent(c),a.preventDefault()}function c(){document.addEventListener("touchstart",b,!0),document.addEventListener("touchmove",b,!0),document.addEventListener("touchend",b,!0),document.addEventListener("touchcancel",b,!0)}return{templateUrl:"../../views/tb-playingcard.html",restrict:"E",scope:{card:"=info",throwCard:"&callbackFn"},link:function(b,d){function e(a){k.prop("scrollLeft"),j=a.pageY-h,i=a.pageX-g,j>0&&(j=0),d.css({top:j+"px"})}function f(){var c=d.children()[0].offsetHeight/2,k=Math.abs(parseInt(d.css("top")));d.addClass("playing-card-animation"),k>c?b.throwCard(b.card)===!1?(d.css({top:0}),d.parent().css({"z-index":1})):d.css({top:-(2*c+50)+"px"}):(d.css({top:0}),d.parent().css({"z-index":1})),g=0,h=0,i=0,j=0,a.unbind("mousemove",e),a.unbind("mouseup",f)}var g=0,h=0,i=0,j=0,k=d.parent().parent();c(),d.css({position:"relative"}),d.on("mousedown",function(b){b.preventDefault(),d.removeClass("playing-card-animation"),d.parent().css({"z-index":99}),h=b.pageY-j,g=b.pageX-i,a.on("mousemove",e),a.on("mouseup",f)})}}}]),angular.module("clientApp").directive("modalDialog",function(){return{templateUrl:"../../views/modaldialog.html",restrict:"E",scope:{winnerName:"=info"}}});